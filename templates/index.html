{% extends 'base.html' %}

{% block title %}Crear Nuevo Curso - Cursia{% endblock %}

{% block breadcrumb %}
<div class="container mt-3">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Crear Curso</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb eliminado aquí para evitar duplicado -->

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Hero Section -->
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold mb-3" style="color: var(--primary-color);">
                    <i class="fas fa-magic me-3"></i>
                    Crear Nuevo Curso
                </h1>
                <p class="lead text-muted mb-4">
                    Genera cursos educativos completos y estructurados en segundos 
                    usando solo un prompt simple. IA + Audio + Video = Educación Inteligente.
                </p>
            <div class="row text-center">
                <div class="col-md-4">
                    <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                    <h6>Claude AI</h6>
                    <small class="text-muted">Contenido inteligente</small>
                </div>
                <div class="col-md-4">
                    <i class="fas fa-volume-up fa-2x text-success mb-2"></i>
                    <h6>AWS Polly</h6>
                    <small class="text-muted">Síntesis de voz neural</small>
                </div>
                <div class="col-md-4">
                    <i class="fab fa-youtube fa-2x text-danger mb-2"></i>
                    <h6>YouTube API</h6>
                    <small class="text-muted">Videos educativos</small>
                </div>
            </div>
        </div>

        <!-- Formulario de Creación -->
        <div class="card course-card mb-4">
            <div class="card-body p-4">
                <h3 class="card-title text-center mb-4">
                    <i class="fas fa-rocket me-2"></i>
                    Crear Nuevo Curso
                </h3>
                
                <form id="courseForm" action="{% url 'create_course' %}" method="post">
                    {% csrf_token %}
                    <!-- Prompt del Usuario -->
                    <div class="mb-4">
                        <label for="user_prompt" class="form-label fw-bold">
                            <i class="fas fa-lightbulb me-1"></i>
                            ¿Qué quieres aprender?
                        </label>
                        <textarea 
                            class="form-control" 
                            id="user_prompt" 
                            name="user_prompt" 
                            rows="3" 
                            placeholder="Ejemplo: quiero aprender Machine Learning para analizar datos deportivos"
                            required
                            minlength="10"
                        ></textarea>
                        <div class="form-text">
                            Describe específicamente qué quieres aprender. Mínimo 10 caracteres.
                        </div>
                    </div>

                    <!-- Nivel de Experiencia -->
                    <div class="mb-4">
                        <label for="user_level" class="form-label fw-bold">
                            <i class="fas fa-chart-line me-1"></i>
                            Nivel de Experiencia
                        </label>
                        <select class="form-select" id="user_level" name="user_level" required>
                            <option value="">Selecciona tu nivel</option>
                            <option value="principiante">
                                <i class="fas fa-seedling"></i>
                                Principiante - Empezando desde cero
                            </option>
                            <option value="intermedio">
                                <i class="fas fa-tree"></i>
                                Intermedio - Tengo conocimientos básicos
                            </option>
                            <option value="avanzado">
                                <i class="fas fa-mountain"></i>
                                Avanzado - Quiero profundizar mis conocimientos
                            </option>
                        </select>
                    </div>

                    <!-- Intereses (Tags) -->
                    <div class="mb-4">
                        <label for="interests" class="form-label fw-bold">
                            <i class="fas fa-tags me-1"></i>
                            Tus Intereses (Opcional)
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Tecnología" id="tech">
                                    <label class="form-check-label" for="tech">Tecnología</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Deportes" id="sports">
                                    <label class="form-check-label" for="sports">Deportes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Negocios" id="business">
                                    <label class="form-check-label" for="business">Negocios</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Arte" id="art">
                                    <label class="form-check-label" for="art">Arte y Diseño</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Ciencia" id="science">
                                    <label class="form-check-label" for="science">Ciencia</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Salud" id="health">
                                    <label class="form-check-label" for="health">Salud</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Educación" id="education">
                                    <label class="form-check-label" for="education">Educación</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Marketing" id="marketing">
                                    <label class="form-check-label" for="marketing">Marketing</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">
                            Selecciona tus áreas de interés para personalizar el contenido.
                        </div>
                    </div>

                    <!-- Botón de Envío -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg px-5 py-2" id="submitBtn">
                            <i class="fas fa-sparkles me-2"></i>
                            Generar Curso Inteligente
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Área de Resultados -->
        <div id="result-area">
            <!-- Aquí se mostrará el progreso y resultado del curso -->
        </div>

        <!-- Ejemplos de Uso -->
        <div class="card course-card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-lightbulb me-2"></i>
                    Ejemplos de Prompts Exitosos
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded mb-3">
                            <strong>Tecnología:</strong><br>
                            <em>"Quiero aprender desarrollo web con React para crear aplicaciones modernas"</em>
                        </div>
                        <div class="p-3 bg-light rounded mb-3">
                            <strong>Deportes:</strong><br>
                            <em>"Necesito entender análisis de datos deportivos para mejorar rendimiento"</em>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded mb-3">
                            <strong>Negocios:</strong><br>
                            <em>"Quiero aprender marketing digital para hacer crecer mi empresa"</em>
                        </div>
                        <div class="p-3 bg-light rounded mb-3">
                            <strong>Arte:</strong><br>
                            <em>"Necesito dominar diseño gráfico con herramientas profesionales"</em>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variable global para intereses seleccionados (debe estar antes de usarla)
    var selectedInterests = [];

    // Piscina de quotes / micro-tips categorizados
    const quotesPool = {
        'Tecnología': [
            "La tecnología está hecha para amplificar la imaginación humana.",
            "Cada línea de código es un paso hacia el futuro."
        ],
        'Deportes': [
            "La constancia vence al talento cuando el talento no se esfuerza.",
            "El sudor de hoy es el éxito de mañana."
        ],
        'Negocios': [
            "Las grandes ideas nacen de grandes retos.",
            "Emprender es convertir problemas en oportunidades."
        ],
        'Arte': [
            "La creatividad es la inteligencia divirtiéndose.",
            "El arte lava del alma el polvo de la rutina."
        ],
        'Ciencia': [
            "La ciencia no es solo un conjunto de conocimientos, es una manera de pensar.",
            "Preguntar es la semilla de todo descubrimiento."
        ],
        'Salud': [
            "Tu cuerpo escucha todo lo que dice tu mente.",
            "La salud es la riqueza real y no piezas de oro y plata."
        ],
        'Educación': [
            "Aprender nunca agota la mente.",
            "La educación es el arma más poderosa para cambiar el mundo."
        ],
        'Marketing': [
            "Convierte a los extraños en amigos y a los amigos en clientes.",
            "El buen marketing hace que la empresa parezca inteligente."
        ],
        'default': [
            "Cada segundo cuenta, ¡sigue avanzando!",
            "El conocimiento es un viaje, no un destino."
        ]
    };

    // Variables globales para controlar la carga
    let pollInterval = null;
    let timeoutTimer = null;
    let courseFinished = false;

    // Devuelve una quote aleatoria basada en los intereses seleccionados
    function getRandomQuote() {
        let pool = [];
        selectedInterests.forEach(int => {
            if (quotesPool[int]) {
                pool = pool.concat(quotesPool[int]);
            }
        });
        if (pool.length === 0) {
            pool = quotesPool['default'];
        }
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function showInitialProgress(courseId) {
        document.getElementById('result-area').innerHTML = `
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle me-2"></i>Curso Creado Exitosamente</h5>
                <p>Tu curso está siendo generado. ID: <code>${courseId}</code></p>
                <div class="progress mb-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 25%"></div>
                </div>
                <small>Generando metadata del curso...</small>
                <div class="mt-3 fst-italic text-secondary">"${getRandomQuote()}"</div>
            </div>
        `;
    }

    function startPolling(courseId) {
        // Reiniciar timers si fuese necesario
        if (pollInterval) clearInterval(pollInterval);
        if (timeoutTimer) clearTimeout(timeoutTimer);
        courseFinished = false;

        pollInterval = setInterval(function() {
            fetch(`/course/${courseId}/status/`)
                .then(response => response.json())
                .then(data => {
                    updateProgress(data);

                    // Manejar errores
                    if (data.status === 'failed') {
                        clearInterval(pollInterval);
                        clearTimeout(timeoutTimer);
                        showError();
                        return;
                    }

                    // Mostrar disponibilidad temprana y, si está completo, detener timers
                    if ([
                        'metadata_ready',
                        'generating_module_1',
                        'ready',
                        'generating_remaining',
                        'complete'
                    ].includes(data.status)) {
                        showCourseReady(courseId, data);

                        if (data.status === 'complete') {
                            courseFinished = true;
                            clearInterval(pollInterval);
                            clearTimeout(timeoutTimer);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error polling course status:', error);
                    clearInterval(pollInterval);
                    clearTimeout(timeoutTimer);
                    showError();
                });
        }, 5000); // Poll cada 5 segundos

        // Timeout de 40s para evitar espera indefinida
        timeoutTimer = setTimeout(function() {
            if (!courseFinished) {
                clearInterval(pollInterval);
                showTimeoutError();
            }
        }, 40000);
    }

    function updateProgress(data) {
        let progressPercent = data.progress_percentage || 0;
        let statusText = getStatusText(data.status);

        document.getElementById('result-area').innerHTML = `
            <div class="alert alert-info">
                <h5><i class="fas fa-cog fa-spin me-2"></i>Generando Curso</h5>
                <p class="mb-1">Estado: <strong>${statusText}</strong></p>
                <div class="progress mb-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${progressPercent}%"></div>
                </div>
                <small class="d-block mb-2">${progressPercent}% completado</small>
                <em class="text-secondary">"${getRandomQuote()}"</em>
            </div>
        `;
    }

    function getStatusText(status) {
        const statusMap = {
            'generating_metadata': 'Generando estructura del curso...',
            'metadata_ready': 'Estructura lista - ¡Ya puedes ver el curso!',
            'generating_module_1': 'Preparando contenido inicial...',
            'ready': 'Primer módulo listo - ¡Puedes empezar!',
            'generating_remaining': 'Completando módulos restantes...',
            'complete': 'Curso completamente generado',
            'failed': 'Error en la generación'
        };
        return statusMap[status] || status;
    }

    function showCourseReady(courseId, data) {
        let statusMessage = '';
        let statusClass = 'success';
        
        if (data.status === 'metadata_ready') {
            statusMessage = 'Estructura del curso lista. El contenido se está generando en background.';
            statusClass = 'info';
        } else if (data.status === 'generating_module_1') {
            statusMessage = 'Puedes explorar la estructura mientras generamos el primer módulo.';
            statusClass = 'info';
        } else if (data.status === 'ready') {
            statusMessage = 'Primer módulo listo. Los módulos restantes se están generando mientras navegas.';
            statusClass = 'success';
        } else if (data.status === 'generating_remaining') {
            statusMessage = 'Primer módulo disponible. Módulos restantes generándose en background.';
            statusClass = 'success';
        } else if (data.status === 'complete') {
            statusMessage = 'Curso completamente generado y listo para consumir.';
            statusClass = 'success';
        }
        
        document.getElementById('result-area').innerHTML = `
            <div class="alert alert-${statusClass}">
                <h5><i class="fas fa-check-circle me-2"></i>¡Curso Disponible!</h5>
                <p><strong>${data.title || 'Tu curso'}</strong></p>
                <p class="mb-3">${statusMessage}</p>
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <a href="/course/${courseId}/" class="btn btn-primary">
                        <i class="fas fa-play me-2"></i>Ver Curso
                    </a>
                    <a href="{% url 'users:dashboard' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                    </a>
                </div>
            </div>
        `;
    }

    function showError() {
        document.getElementById('result-area').innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Error</h5>
                <p>Hubo un problema generando tu curso. Por favor, inténtalo de nuevo.</p>
                <button class="btn btn-outline-danger" onclick="location.reload()">
                    <i class="fas fa-redo me-2"></i>Intentar de Nuevo
                </button>
            </div>
        `;
    }

    function showTimeoutError() {
        document.getElementById('result-area').innerHTML = `
            <div class="alert alert-warning">
                <h5><i class="fas fa-hourglass-half me-2"></i>Esto está tardando más de lo esperado</h5>
                <p>Puede que algo haya fallado durante la generación. ¡No te preocupes! Puedes reintentar usando tu mismo prompt sin perder nada.</p>
                <button class="btn btn-primary me-2" onclick="location.reload()">
                    <i class="fas fa-redo me-1"></i>Reintentar
                </button>
            </div>
        `;
    }

    // Manejar formulario y enviar datos al backend
    document.getElementById('courseForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const form = this;
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;

        // Deshabilitar botón y mostrar spinner
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';

        // Recolectar intereses seleccionados
        const interests = [];
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(function(checkbox) {
            interests.push(checkbox.value);
        });
        selectedInterests = interests; // Guardamos intereses para las quotes

        // Preparar datos de formulario
        const formData = new FormData(form);
        formData.set('user_interests', JSON.stringify(interests));

        // Enviar solicitud
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            } else {
                const courseId = data.id;
                showInitialProgress(courseId);
                startPolling(courseId);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al crear el curso. Por favor intenta de nuevo.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
</script>
{% endblock %} 