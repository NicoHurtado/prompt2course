{% extends 'base.html' %}

{% load markdown_filters %}

{% block title %}{{ course.title }}{% endblock %}

{% block breadcrumb %}
<div class="container mt-3">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'users:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ course.title|truncatechars:40 }}</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<!-- Loading Overlay for Generating Courses -->
{% if course.status == 'generating_metadata' or course.status == 'generating_modules_metadata' or course.status == 'generating_module_1' %}
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="loading-animation">
            <div class="ai-brain">
                <div class="brain-pulse"></div>
                <i class="fas fa-brain"></i>
            </div>
        </div>
        <h3 class="loading-title">Generando tu curso con IA</h3>
        <p class="loading-subtitle" id="loadingMessage">
            {% if course.status == 'generating_metadata' %}
                Analizando tu tema y creando la estructura del curso...
            {% elif course.status == 'generating_modules_metadata' %}
                Diseñando los módulos y objetivos de aprendizaje...
            {% elif course.status == 'generating_module_1' %}
                Creando el contenido del primer módulo...
            {% endif %}
        </p>
        <div class="loading-progress">
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>
            <div class="progress-steps">
                <div class="step {% if course.status == 'generating_metadata' %}active{% elif course.status == 'generating_modules_metadata' or course.status == 'generating_module_1' %}completed{% endif %}">
                    <div class="step-icon">1</div>
                    <span>Metadata</span>
                </div>
                <div class="step {% if course.status == 'generating_modules_metadata' %}active{% elif course.status == 'generating_module_1' %}completed{% endif %}">
                    <div class="step-icon">2</div>
                    <span>Estructura</span>
                </div>
                <div class="step {% if course.status == 'generating_module_1' %}active{% endif %}">
                    <div class="step-icon">3</div>
                    <span>Contenido</span>
                </div>
            </div>
        </div>
        <div class="loading-tips">
            <div class="tip-card">
                <i class="fas fa-lightbulb"></i>
                <span>Mientras tanto, puedes explorar otros cursos en tu dashboard</span>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- Course Sidebar -->
    <div class="col-lg-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-2">Progreso del Curso</h6>
                {% if user_progress %}
                <div class="progress mb-2">
                    <div class="progress-bar bg-success" role="progress-bar" 
                         style="width: {{ user_progress.get_completion_percentage }}%">
                    </div>
                </div>
                <small class="text-muted">{{ user_progress.get_completion_percentage }}% completado</small>
                {% else %}
                <div class="progress mb-2">
                    <div class="progress-bar bg-secondary" role="progress-bar" style="width: 0%"></div>
                </div>
                <small class="text-muted">0% completado</small>
                {% endif %}
            </div>
        </div>
        
        <!-- Course Info -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="text-muted mb-3">Información del Curso</h6>
                <div class="mb-2">
                    <small class="text-muted">Nivel:</small><br>
                    <span class="badge bg-secondary">{{ course.get_user_level_display }}</span>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Módulos:</small><br>
                    <span class="fw-bold">{{ course.total_modules }}</span>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Estado:</small><br>
                    <span class="badge bg-primary" id="courseStatusBadge">{{ course.get_status_display }}</span>
                </div>
                <div>
                    <small class="text-muted">Tamaño:</small><br>
                    <span class="text-success">{{ course.total_size_estimate|default:"~300KB" }}</span>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="text-muted mb-3">Acciones Rápidas</h6>
                <div class="d-grid gap-2">
                    {% if user_progress.current_module %}
                        <a href="{% url 'module_view' course_id=course.id module_id=user_progress.current_module.module_id %}" 
                           class="btn btn-primary btn-sm">
                            <i class="fas fa-play me-2"></i>
                            Continuar
                        </a>
                    {% endif %}
                    {% if course.podcast_audio_url %}
                    <button class="btn btn-outline-primary btn-sm" onclick="openPodcastPlayer()">
                        <i class="fas fa-podcast me-2"></i>
                        Reproducir Podcast
                    </button>
                    {% endif %}
                    <a href="{% url 'users:dashboard' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-home me-2"></i>
                        Dashboard
                    </a>
                </div>
            </div>
        </div>
        <!-- User Prompt & Interests -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="text-muted mb-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    Prompt original del usuario
                </h6>

                <!-- Prompt elegant box -->
                <div class="bg-light border rounded p-3">
                    <p class="mb-0" style="white-space: pre-wrap;">{{ course.user_prompt|linebreaksbr }}</p>
                </div>

                <!-- User interests -->
                {% if course.user_interests %}
                <div class="mt-3">
                    <small class="text-muted">Intereses seleccionados:</small>
                    <div class="mt-1">
                        {% for interest in course.user_interests %}
                        <span class="badge bg-light text-dark border me-1">{{ interest }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9">
        <!-- Course Header -->
        <div class="card course-card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h1 class="card-title h2 mb-2">{{ course.title }}</h1>
                        <span class="badge bg-primary status-badge" id="mainStatusBadge">{{ course.get_status_display }}</span>
                        {% if course.status == 'complete' %}
                        <span class="badge bg-success ms-2">
                            <i class="fas fa-check me-1"></i>Completado
                        </span>
                        {% endif %}
                    </div>
                    <div class="text-end">
                        <small class="text-muted">ID: {{ course.course_id }}</small>
                        <br>
                        <small class="text-muted">{{ course.created_at|date:"d/m/Y H:i" }}</small>
                    </div>
                </div>
                
                <p class="card-text lead">{{ course.description }}</p>
            </div>
        </div>

        <!-- Course Introduction -->
        {% if course.introduction %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-play me-2"></i>
                    Introducción al Curso
                </h5>
            </div>
            <div class="card-body">
                <div class="chunk-content mb-4">
                    {{ course.introduction|markdownify }}
                </div>
                
                <!-- Botón Reproduce Intro -->
                <div class="text-center">
                    <button class="btn btn-success btn-lg" onclick="playIntroAudio()">
                        <i class="fas fa-play me-2"></i>
                        Reproduce Intro al Curso
                    </button>
                </div>
                
                <!-- Audio del podcast introductorio (oculto por defecto) -->
                <div id="intro-audio-container" class="mt-4" style="display: none;">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-podcast me-2"></i>Podcast Introductorio con María y Carlos</h6>
                        <p class="mb-3">Escucha esta introducción especial al curso donde María y Carlos te explican qué aprenderás.</p>
                        
                        {% if course.podcast_audio_url %}
                            <audio id="intro-audio" controls class="w-100 mb-3">
                                <source src="{{ course.podcast_audio_url }}" type="audio/mpeg">
                                Tu navegador no soporta el elemento de audio.
                            </audio>
                        {% else %}
                            <!-- Audio simulado si no hay URL real -->
                            <div class="audio-simulator p-3 border rounded mb-3">
                                <div class="d-flex align-items-center">
                                    <button id="play-pause-btn" class="btn btn-primary btn-sm me-3" onclick="toggleAudioSimulator()">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small>Podcast Introductorio</small>
                                            <small id="audio-time">0:00 / 2:30</small>
                                        </div>
                                        <div class="progress">
                                            <div id="audio-progress" class="progress-bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if course.podcast_script %}
                        <details>
                            <summary class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-file-text me-1"></i>
                                Ver Transcripción
                            </summary>
                            <div class="mt-3 p-3 bg-light rounded">
                                <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">{{ course.podcast_script }}</pre>
                            </div>
                        </details>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Course Modules -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-book-open me-2"></i>
                    Módulos del Curso
                </h5>
            </div>
            <div class="card-body">
                <div class="modules-container" id="modulesContainer">
                    {% if course.modules.all %}
                        <!-- Mostrar módulos completos cuando están disponibles -->
                        {% for module in course.modules.all %}
                        <div class="module-card border rounded p-4 mb-3 {% if user_progress.current_module.id == module.id %}border-primary{% endif %}">
                            <div class="row align-items-center">
                                <div class="col-lg-8">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-primary rounded-pill me-3">{{ module.module_order }}</span>
                                        <h5 class="mb-0">{{ module.title }}</h5>
                                        {% if user_progress.current_module.id == module.id %}
                                        <span class="badge bg-warning ms-2">Actual</span>
                                        {% endif %}
                                    </div>
                                    <p class="text-muted mb-2">{{ module.description|truncatewords:20 }}</p>
                                    
                                    <!-- Module progress -->
                                    {% if user_progress %}
                                    <div class="module-progress">
                                        {% with module_chunks=module.chunks.all %}
                                        {% with completed_count=user_progress.completed_chunks|length %}
                                        <small class="text-muted">
                                            <i class="fas fa-file-text me-1"></i>
                                            {{ module_chunks|length }} partes
                                            {% if completed_count > 0 %}
                                                • {{ completed_count }} completadas
                                            {% endif %}
                                        </small>
                                        {% endwith %}
                                        {% endwith %}
                                    </div>
                                    
                                    {# Nueva barra de progreso por módulo #}
                                    {% with module_chunks=module.chunks.all %}
                                        {% if module_chunks %}
                                            {% with total_expected=module_chunks.0.total_chunks %}
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-primary" role="progress-bar" style="width: {% widthratio module_chunks|length total_expected 100 %}%;"></div>
                                                </div>
                                            {% endwith %}
                                        {% else %}
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-secondary" role="progress-bar" style="width: 0%;"></div>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                    {% endif %}
                                </div>
                                <div class="col-lg-4 text-lg-end">
                                    <a href="{% url 'module_view' course_id=course.id module_id=module.module_id %}" 
                                       class="btn btn-primary">
                                        <i class="fas fa-arrow-right me-2"></i>
                                        Estudiar Módulo
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Module concepts preview -->
                            {% if module.concepts %}
                            <div class="mt-3">
                                <small class="text-muted">Conceptos clave:</small>
                                <div class="mt-1">
                                    {% for concept in module.concepts|slice:":4" %}
                                    <span class="badge bg-light text-dark border me-1">{{ concept }}</span>
                                    {% endfor %}
                                    {% if module.concepts|length > 4 %}
                                    <span class="badge bg-light text-muted border">+{{ module.concepts|length|add:"-4" }} más</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% elif course.module_list %}
                        <!-- Mostrar preview de módulos cuando solo hay metadata -->
                        {% for module_title in course.module_list %}
                        <div class="module-card border rounded p-4 mb-3 border-info">
                            <div class="row align-items-center">
                                <div class="col-lg-8">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-info rounded-pill me-3">{{ forloop.counter }}</span>
                                        <h5 class="mb-0">{{ module_title }}</h5>
                                        <span class="badge bg-info ms-2">
                                            {% if forloop.counter == 1 and course.status == 'generating_module_1' %}
                                                Generando...
                                            {% elif forloop.counter == 1 and course.status == 'ready' %}
                                                Listo
                                            {% else %}
                                                Pendiente
                                            {% endif %}
                                        </span>
                                    </div>
                                    <p class="text-muted mb-2">Contenido en proceso de generación...</p>
                                </div>
                                <div class="col-lg-4 text-lg-end">
                                    {% if forloop.counter == 1 and course.status == 'ready' %}
                                        <a href="{% url 'module_view' course_id=course.id module_id='modulo_1' %}" 
                                           class="btn btn-primary">
                                            <i class="fas fa-arrow-right me-2"></i>
                                            Estudiar Módulo
                                        </a>
                                    {% else %}
                                        <button class="btn btn-outline-secondary" disabled>
                                            <i class="fas fa-clock me-2"></i>
                                            {% if forloop.counter == 1 %}En progreso...{% else %}Próximamente{% endif %}
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <!-- Fallback cuando no hay información de módulos -->
                        <div class="text-center py-4">
                            <i class="fas fa-book fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">Módulos en preparación</h6>
                            <p class="text-muted mb-0">La estructura del curso se está generando...</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Final Project -->
        {% if course.final_project_data %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>
                    Proyecto Final
                </h5>
            </div>
            <div class="card-body">
                {% if course.final_project_data.title %}
                    <h6>{{ course.final_project_data.title }}</h6>
                {% endif %}
                {% if course.final_project_data.description %}
                    <p>{{ course.final_project_data.description }}</p>
                {% endif %}
                {% if course.final_project_data.objectives %}
                    <h6 class="mt-3">Objetivos:</h6>
                    <ul>
                        {% for objective in course.final_project_data.objectives %}
                        <li>{{ objective }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                {% if course.final_project_data.deliverables %}
                    <h6 class="mt-3">Entregables:</h6>
                    <ul>
                        {% for deliverable in course.final_project_data.deliverables %}
                        <li>{{ deliverable }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Prerequisites -->
        {% if course.prerequisites %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list-check me-2"></i>
                    Prerrequisitos
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for prerequisite in course.prerequisites %}
                    <li class="list-group-item">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        {{ prerequisite }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Success Notification Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="success-animation mb-4">
                    <div class="checkmark">
                        <div class="checkmark-stem"></div>
                        <div class="checkmark-kick"></div>
                    </div>
                </div>
                <h4 class="fw-bold text-success mb-3">¡Curso Listo!</h4>
                <p class="text-muted mb-4">Tu curso ha sido generado exitosamente. Ya puedes empezar a aprender.</p>
                <button type="button" class="btn btn-success btn-lg" data-bs-dismiss="modal">
                    <i class="fas fa-rocket me-2"></i>
                    ¡Empezar a Aprender!
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Course status polling
let pollingInterval;
const courseId = '{{ course.id }}';
const currentStatus = '{{ course.status }}';

// Start polling if course is generating
if (['generating_metadata', 'generating_modules_metadata', 'generating_module_1'].includes(currentStatus)) {
    startPolling();
}

function startPolling() {
    pollingInterval = setInterval(checkCourseStatus, 3000); // Check every 3 seconds
}

function checkCourseStatus() {
    fetch(`/course/${courseId}/status/`)
        .then(response => response.json())
        .then(data => {
            if (data.status !== currentStatus) {
                // Status changed, reload page to show new content
                showSuccessNotification();
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error checking course status:', error);
        });
}

function showSuccessNotification() {
    // Stop polling
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    
    // Hide loading overlay
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 500);
    }
    
    // Show success modal
    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
    successModal.show();
}

// Progress bar animation
function animateProgressBar() {
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
            
            if (progress >= 90) {
                clearInterval(interval);
            }
        }, 2000);
    }
}

// Start progress animation if loading overlay exists
if (document.getElementById('loadingOverlay')) {
    animateProgressBar();
}

// Audio simulator functions
let audioSimulatorInterval;
let currentTime = 0;
const totalTime = 150; // 2:30 in seconds

function toggleAudioSimulator() {
    const btn = document.getElementById('play-pause-btn');
    const icon = btn.querySelector('i');
    const timeDisplay = document.getElementById('audio-time');
    const progressBar = document.getElementById('audio-progress');
    
    if (icon.classList.contains('fa-play')) {
        // Start playing
        icon.classList.remove('fa-play');
        icon.classList.add('fa-pause');
        
        audioSimulatorInterval = setInterval(() => {
            currentTime++;
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            const totalMinutes = Math.floor(totalTime / 60);
            const totalSeconds = totalTime % 60;
            
            timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} / ${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            progressBar.style.width = (currentTime / totalTime * 100) + '%';
            
            if (currentTime >= totalTime) {
                stopAudioSimulator();
            }
        }, 1000);
    } else {
        // Pause
        stopAudioSimulator();
    }
}

function stopAudioSimulator() {
    const btn = document.getElementById('play-pause-btn');
    const icon = btn.querySelector('i');
    
    icon.classList.remove('fa-pause');
    icon.classList.add('fa-play');
    
    if (audioSimulatorInterval) {
        clearInterval(audioSimulatorInterval);
    }
}

function playIntroAudio() {
    const container = document.getElementById('intro-audio-container');
    container.style.display = 'block';
    
    // Scroll to audio
    container.scrollIntoView({ behavior: 'smooth' });
    
    // Auto-play if real audio exists
    const audio = document.getElementById('intro-audio');
    if (audio) {
        setTimeout(() => {
            audio.play().catch(e => console.log('Auto-play prevented:', e));
        }, 500);
    }
}

function openPodcastPlayer() {
    // Create modal if it doesn't exist
    if (!document.getElementById('podcastModal')) {
        createPodcastModal();
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('podcastModal'));
    modal.show();
    
    // Auto-play audio after modal shows
    setTimeout(() => {
        const audio = document.getElementById('podcastAudio');
        if (audio) {
            // Agregar event listeners para debugging
            audio.addEventListener('loadstart', () => console.log('🎵 Audio: Iniciando carga'));
            audio.addEventListener('canplay', () => console.log('✅ Audio: Listo para reproducir'));
            audio.addEventListener('error', (e) => console.error('❌ Audio Error:', e));
            
            audio.play().catch(e => console.log('⚠️ Auto-play prevented:', e));
        } else {
            console.warn('⚠️ Audio element no encontrado');
        }
    }, 500);
}

function createPodcastModal() {
    // Obtener datos del curso desde variables JavaScript
    const courseTitle = '{{ course.title|escapejs }}';
    const podcastUrl = '{{ course.podcast_audio_url|escapejs }}';
    const podcastScript = `{{ course.podcast_script|escapejs }}`;
    const courseId = '{{ course.id }}';
    
    // DEBUG: Mostrar información en consola
    console.log('🎙️ DEBUG Podcast Modal:', {
        courseTitle: courseTitle,
        podcastUrl: podcastUrl,
        hasScript: !!podcastScript,
        courseId: courseId
    });
    
    let audioPlayerHTML = '';
    if (podcastUrl && podcastUrl.trim() !== '') {
        audioPlayerHTML = `
            <div class="audio-player-container">
                <audio id="podcastAudio" controls class="w-100" preload="metadata" crossorigin="anonymous">
                    <source src="${podcastUrl}" type="audio/mpeg">
                    Tu navegador no soporta el reproductor de audio.
                </audio>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Conversación entre María (voz femenina) y Carlos (voz masculina)
                    </small>
                </div>
                <div class="mt-2">
                    <small class="text-info">
                        <i class="fas fa-link me-1"></i>
                        URL: ${podcastUrl.substring(0, 60)}...
                    </small>
                </div>
            </div>
        `;
    } else {
        audioPlayerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                El podcast conversacional se está generando. Intenta de nuevo en unos momentos.
                <br><small class="text-muted">Estado: URL vacía o no válida</small>
            </div>
        `;
    }
    
    let transcriptHTML = '';
    if (podcastScript) {
        transcriptHTML = `
            <div class="mt-4">
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#modalPodcastScript">
                    <i class="fas fa-file-text me-1"></i>
                    Ver Transcripción Completa
                </button>
                <div class="collapse mt-3" id="modalPodcastScript">
                    <div class="card">
                        <div class="card-body">
                            <div style="max-height: 300px; overflow-y: auto;">
                                <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit; font-size: 0.9rem;">${podcastScript}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    const modalHTML = `
        <div class="modal fade" id="podcastModal" tabindex="-1" aria-labelledby="podcastModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="podcastModalLabel">
                            <i class="fas fa-podcast me-2"></i>
                            Conversación Introductoria - ${courseTitle.substring(0, 40)}${courseTitle.length > 40 ? '...' : ''}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <div class="d-inline-flex align-items-center bg-light rounded-pill px-4 py-2">
                                <div class="me-3">
                                    <i class="fas fa-user-circle fa-2x text-primary"></i>
                                    <div class="small text-muted">María</div>
                                </div>
                                <div class="mx-2">
                                    <i class="fas fa-comments text-muted"></i>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-user-circle fa-2x text-success"></i>
                                    <div class="small text-muted">Carlos</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <p class="mb-0">
                                <strong>¡Escucha la conversación especial!</strong><br>
                                María y Carlos conversan sobre el curso, qué aprenderás 
                                y por qué es importante en menos de 1 minuto y 30 segundos.
                            </p>
                        </div>
                        
                        ${audioPlayerHTML}
                        ${transcriptHTML}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            Cerrar
                        </button>
                        <a href="/course/${courseId}/module/modulo_1/" class="btn btn-success">
                            <i class="fas fa-rocket me-2"></i>
                            ¡Empezar Curso!
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Loading Overlay Styles */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.5s ease;
    }

    .loading-content {
        text-align: center;
        color: white;
        max-width: 600px;
        padding: 2rem;
    }

    .loading-animation {
        margin-bottom: 2rem;
    }

    .ai-brain {
        position: relative;
        display: inline-block;
        font-size: 4rem;
        color: white;
    }

    .brain-pulse {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100px;
        height: 100px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(1.5);
            opacity: 0;
        }
    }

    .loading-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .loading-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 2rem;
    }

    .loading-progress {
        margin-bottom: 2rem;
    }

    .progress-bar-container {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .progress-bar-fill {
        height: 100%;
        background: white;
        border-radius: 4px;
        width: 0%;
        transition: width 0.5s ease;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        opacity: 0.5;
        transition: opacity 0.3s ease;
    }

    .step.active {
        opacity: 1;
    }

    .step.completed {
        opacity: 1;
    }

    .step-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
        transition: background 0.3s ease;
    }

    .step.active .step-icon {
        background: white;
        color: #667eea;
    }

    .step.completed .step-icon {
        background: #28a745;
        color: white;
    }

    .loading-tips {
        margin-top: 2rem;
    }

    .tip-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .tip-card i {
        font-size: 1.5rem;
        color: #ffd700;
    }

    /* Success Modal Styles */
    .success-animation {
        display: flex;
        justify-content: center;
    }

    .checkmark {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: block;
        stroke-width: 4;
        stroke: #28a745;
        stroke-miterlimit: 10;
        box-shadow: inset 0px 0px 0px #28a745;
        animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        position: relative;
        margin: 0 auto;
    }

    .checkmark-stem {
        position: absolute;
        width: 3px;
        height: 30px;
        background-color: #28a745;
        left: 25px;
        top: 15px;
        transform: rotate(45deg);
        animation: checkmark-stem 0.3s ease-out 0.9s both;
    }

    .checkmark-kick {
        position: absolute;
        width: 15px;
        height: 3px;
        background-color: #28a745;
        left: 10px;
        top: 35px;
        transform: rotate(45deg);
        animation: checkmark-kick 0.3s ease-out 1.2s both;
    }

    @keyframes checkmark-stem {
        0% { height: 0; }
        100% { height: 30px; }
    }

    @keyframes checkmark-kick {
        0% { width: 0; }
        100% { width: 15px; }
    }

    @keyframes fill {
        100% { box-shadow: inset 0px 0px 0px 30px #28a745; }
    }

    @keyframes scale {
        0%, 100% { transform: none; }
        50% { transform: scale3d(1.1, 1.1, 1); }
    }

    /* Existing Styles */
    .module-card {
        transition: all 0.2s;
        background-color: #fff;
    }
    
    .module-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .chunk-content {
        font-size: 1.1rem;
        line-height: 1.6;
    }
    
    .status-badge {
        font-size: 0.75rem;
    }
    
    audio {
        height: 40px;
        border-radius: 8px;
    }
    
    .audio-player-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e9ecef;
    }
    
    #podcastAudio {
        width: 100%;
        height: 50px;
        border-radius: 8px;
    }
    
    .modal-body .alert {
        border-radius: 10px;
    }
    
    .module-progress {
        margin-top: 8px;
    }

    /* --- Colores personalizados para highlight.js --- */
    .markdown-body .hljs-keyword,
    .markdown-body .hljs-built_in,
    .markdown-body .hljs-title { color: #15803d; }   /* verde */

    .markdown-body .hljs-string { color: #d97706; }  /* naranja */

    .markdown-body .hljs-number,
    .markdown-body .hljs-literal,
    .markdown-body .hljs-punctuation,
    .markdown-body .hljs-operator { color: #2563eb; }  /* azul */
</style>
{% endblock %} 